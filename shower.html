<!DOCTYPE html>
<html>
<head><title>Shower Graphs</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="theme-color" content="#00838F">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel="stylesheet" href="css/material-components-web.min.css">
	<script src="js/material-components-web.min.js"></script>
	<script src="js/highcharts.js"></script>
	<script src="js/query.js"></script>
	<style>
		.graph-header {
			padding: 16px;
			margin: 16px 0;
		}
	</style>
</head>
<body>
<header class="mdc-toolbar mdc-toolbar--fixed mdc-toolbar--waterfall">
	<div class="mdc-toolbar__row">
		<section class="mdc-toolbar__section mdc-toolbar__section--align-start">
			<a href="index.html" class="material-icons mdc-toolbar__icon--menu">arrow_back</a>
			<span class="mdc-toolbar__title">Shower Graphs</span>
		</section>
	</div>
</header>
<main class="mdc-toolbar-fixed-adjust">
	<div style="padding: 16px; display:flex; flex-direction: column">
		<div class="graph-header mdc-theme--text-primary-on-primary mdc-theme--primary-bg mdc-typography--subheading2">Water Flow</div>
		<div id="FLOW"></div>
		<div class="graph-header mdc-theme--text-primary-on-primary mdc-theme--primary-bg mdc-typography--subheading2">Water Temperature</div>
		<div id="TEMP"></div>

		<div class="graph-header mdc-theme--text-primary-on-primary mdc-theme--primary-bg mdc-typography--subheading2">Scale</div>
		<div id="scale"></div>

		<div class="graph-header mdc-theme--text-primary-on-primary mdc-theme--primary-bg mdc-typography--subheading2">Shower Head Magnetometer</div>
		<div id="mag"></div>
		<div class="graph-header mdc-theme--text-primary-on-primary mdc-theme--primary-bg mdc-typography--subheading2">Shower Head Accelerometer</div>
		<div id="acc"></div>
		<div class="graph-header mdc-theme--text-primary-on-primary mdc-theme--primary-bg mdc-typography--subheading2">Shower Head Gyroscope</div>
		<div id="gyr"></div>
	</div>
</main>
<script>
	function drawGraph2(series, axisA, axisB, axisC, start, end, container, ylable) {
		query("select value from " + series + " where axis = '" + axisA + "' and time > " + start + "ms and time < " + end + "ms order by time asc")
			.then((dataA) => {
				query("select value from " + series + " where axis = '" + axisB + "' and time > " + start + "ms and time < " + end + "ms order by time asc")
					.then((dataB) => {
						query("select value from " + series + " where axis = '" + axisC + "' and time > " + start + "ms and time < " + end + "ms order by time asc")
							.then((dataC) => {
								if (dataA.results[0].series) {
									dataA = dataA.results[0].series[0].values;
								}

								if (dataB.results[0].series) {
									dataB = dataB.results[0].series[0].values;
								}

								if (dataC.results[0].series) {
									dataC = dataC.results[0].series[0].values;
								}

								Highcharts.chart(container, {
									title: {text: ''},
									xAxis: {
										type: 'datetime',
										min: start,
										max: end,
										title: {
											text: 'timestamp'
										}
									},
									yAxis: {
										title: {
											text: ylable
										}
									},
									tooltip: {
										headerFormat: '<b>{series.name}</b><br>',
										pointFormat: '{point.y:.1f} {point.x:%e %b, %H:%M:%S}'
									},

									plotOptions: {
										scatter: {
											marker: {
												enabled: true,
												radius: 1.5
											}
										}
									},

									series: [{
										name: axisA,
										data: dataA
									}, {
										name: axisB,
										data: dataB
									}, {
										name: axisC,
										data: dataC
									}]
								});
							});
					});
			});
	}

	function drawGraph(series, axisA, start, end, container, ylable) {
		query("select value from " + series + " where axis = '" + axisA + "' and time >= " + start + "ms and time <= " + end + "ms order by time asc")
			.then(function (dataA) {
				if (dataA.results[0].series) {
					dataA = dataA.results[0].series[0].values;
				}

				Highcharts.chart(container, {
					title: {text: ''},
					legend: {enabled: false},
					xAxis: {
						type: 'datetime',
						min: start,
						max: end,
					},
					yAxis: {
						title: {
							text: ylable
						},
						min: 0
					},
					tooltip: {
						headerFormat: '<b>{series.name}</b><br>',
						pointFormat: '{point.x:%H:%M:%S}, {point.y:.1f}'
					},

					plotOptions: {
						area: {
							fillColor: {
								linearGradient: {
									x1: 0,
									y1: 0,
									x2: 0,
									y2: 1
								},
								stops: [
									[0, Highcharts.getOptions().colors[0]],
									[1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
								]
							},
							marker: {
								radius: 2
							},
							lineWidth: 1,
							states: {
								hover: {
									lineWidth: 1
								}
							},
							threshold: null
						}
					},

					series: [
						{
							name: axisA,
							data: dataA
						}
					]
				});
			});
	}

	function loadShower(start, end) {
		drawGraph("monitor", "FLOW", start, end, 'FLOW', "litres/min");
		drawGraph("monitor", "TEMP", start, end, 'TEMP', "ÂºC");
		drawGraph("scale", "scale", start, end, 'scale', "Weight change g");
		drawGraph2("head", "ax", "ay", "az", start, end, 'acc', "g", "Head Accelerometer");
		drawGraph2("head", "mx", "my", "mz", start, end, 'mag', "g", "Head Magnetometer");
		drawGraph2("head", "gx", "gy", "gz", start, end, 'gyr', "g", "Head Gyroscope");
	}

	function getParameterByName(name) {
		name = name.replace(/[\[\]]/g, "\\$&");
		let regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
			results = regex.exec(window.location.href);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));
	}

	const start = getParameterByName('start');
	const end = getParameterByName('end');
	loadShower(start, end);

	mdc.autoInit();

	let toolbar = mdc.toolbar.MDCToolbar.attachTo(document.querySelector('.mdc-toolbar'));
	toolbar.fixedAdjustElement = document.querySelector('.mdc-toolbar-fixed-adjust');
</script>
</body>
</html>